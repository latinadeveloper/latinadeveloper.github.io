<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Constantes de autocarga y recarga (Zeitwerk Mode) — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/prism/default.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/prism/rails-guides.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/prism.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/responsive-tables.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Constantes de autocarga y recarga (Zeitwerk Mode) — Ruby on Rails Guides" />
  <meta name="description" content="NO LEA ESTE ARCHIVO EN GITHUB, LAS GUÍAS SE PUBLICAN EN https://railsguides.es/Constantes de autocarga y recarga (Zeitwerk Mode)" />
  <meta property="og:description" content="NO LEA ESTE ARCHIVO EN GITHUB, LAS GUÍAS SE PUBLICAN EN https://railsguides.es/Constantes de autocarga y recarga (Zeitwerk Mode)" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
<!--    <img src="images/edge_badge.png" alt="edge-badge" id="edge-badge" />-->
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Más en <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Más Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guías</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://stackoverflow.com/questions/tagged/ruby-on-rails">Pedir Ayuda</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribuir on GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Guías de Ruby on Rails">Guías de Ruby on Rails </a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Inicio</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Index de Guías </a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Empieza Aqui</dt>
                  <dd><a href="getting_started.html">Introducción a Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Modelos</dt>
                  <dd><a href="active_record_basics.html">Conceptos básicos de Active Record</a></dd>
                  <dd><a href="active_record_migrations.html">Migraciones de Active Record</a></dd>
                  <dd><a href="active_record_validations.html">Validaciones de Active Record</a></dd>
                  <dd><a href="active_record_callbacks.html">Devolución (callbacks) de Llamadas de Active Record</a></dd>
                  <dd><a href="association_basics.html">Asociaciones de Active Record</a></dd>
                  <dd><a href="active_record_querying.html">Interfaz de Consulta de Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Vistas</dt>
                  <dd><a href="layouts_and_rendering.html">Diseños y Renderizado en Rails</a></dd>
                  <dd><a href="form_helpers.html">Ayudantes de Formulario de Action</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controladores</dt>
                  <dd><a href="action_controller_overview.html">Descripción General de Action Controller</a></dd>
                  <dd><a href="routing.html">Rails Routing Desde el Exterior Hacia Adentro</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Otros Componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Extensiones de Núcleo de Active Support</a></dd>
                  <dd><a href="action_mailer_basics.html">Conceptos Básicos de Action Mailer</a></dd>
                  <dd><a href="active_job_basics.html">Conceptos Básicos de Active Job</a></dd>
                  <dd><a href="active_storage_overview.html">Descripción General de Active Storage</a></dd>
                  <dd><a href="action_cable_overview.html">Descripción General de Action Cable</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Temas Avanzados</dt>
                  <dd><a href="i18n.html">Rails API de Internacionalización (I18n)</a></dd>
                  <dd><a href="testing.html">Prueba de Aplicaciones de Rails</a></dd>
                  <dd><a href="security.html">Seguridad de Aplicaciones Rails</a></dd>
                  <dd><a href="debugging_rails_applications.html">Depuración de Applications Rails</a></dd>
                  <dd><a href="configuring.html">Configuración de Aplicaciones de Rails</a></dd>
                  <dd><a href="command_line.html">La Línea de Comandos de Rails</a></dd>
                  <dd><a href="asset_pipeline.html">La Canalización de Activos</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Constantes de Autocarga y Recarga (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Constantes de Autocarga y Recarga (modo clásico)</a></dd>
                  <dd><a href="caching_with_rails.html">Almacenamiento en Caché con Rails Descripción General</a></dd>
                  <dd><a href="api_app.html">Uso de Rails para Aplicaciones Solo API</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Extending Rails  (toda la sección necesita traducción)</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribuir</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guides Index</option>
              <optgroup label="Empieza Aqui">
                  <option value="getting_started.html">Introducción a Rails</option>
              </optgroup>
              <optgroup label="Modelos">
                  <option value="active_record_basics.html">Conceptos básicos de Active Record</option>
                  <option value="active_record_migrations.html">Migraciones de Active Record</option>
                  <option value="active_record_validations.html">Validaciones de Active Record</option>
                  <option value="active_record_callbacks.html">Devolución (callbacks) de Llamadas de Active Record</option>
                  <option value="association_basics.html">Asociaciones de Active Record</option>
                  <option value="active_record_querying.html">Interfaz de Consulta de Active Record</option>
              </optgroup>
              <optgroup label="Vistas">
                  <option value="layouts_and_rendering.html">Diseños y Renderizado en Rails</option>
                  <option value="form_helpers.html">Ayudantes de Formulario de Action</option>
              </optgroup>
              <optgroup label="Controladores">
                  <option value="action_controller_overview.html">Descripción General de Action Controller</option>
                  <option value="routing.html">Rails Routing Desde el Exterior Hacia Adentro</option>
              </optgroup>
              <optgroup label="Otros Componentes">
                  <option value="active_support_core_extensions.html">Extensiones de Núcleo de Active Support</option>
                  <option value="action_mailer_basics.html">Conceptos Básicos de Action Mailer</option>
                  <option value="active_job_basics.html">Conceptos Básicos de Active Job</option>
                  <option value="active_storage_overview.html">Descripción General de Active Storage</option>
                  <option value="action_cable_overview.html">Descripción General de Action Cable</option>
              </optgroup>
              <optgroup label="Temas Avanzados">
                  <option value="i18n.html">Rails API de Internacionalización (I18n)</option>
                  <option value="testing.html">Prueba de Aplicaciones de Rails</option>
                  <option value="security.html">Seguridad de Aplicaciones Rails</option>
                  <option value="debugging_rails_applications.html">Depuración de Applications Rails</option>
                  <option value="configuring.html">Configuración de Aplicaciones de Rails</option>
                  <option value="command_line.html">La Línea de Comandos de Rails</option>
                  <option value="asset_pipeline.html">La Canalización de Activos</option>
                  <option value="autoloading_and_reloading_constants.html">Constantes de Autocarga y Recarga (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Constantes de Autocarga y Recarga (modo clásico)</option>
                  <option value="caching_with_rails.html">Almacenamiento en Caché con Rails Descripción General</option>
                  <option value="api_app.html">Uso de Rails para Aplicaciones Solo API</option>
              </optgroup>
              <optgroup label="Extending Rails  (toda la sección necesita traducción)">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <p><strong>NO LEA ESTE ARCHIVO EN GITHUB, LAS GUÍAS SE PUBLICAN EN <a href="https://railsguides.es/">https://railsguides.es/</a></strong></p><h2>Constantes de autocarga y recarga (Zeitwerk Mode)</h2>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#enabling-zeitwerk-mode">Enabling Zeitwerk Mode</a></li>
<li><a href="#project-structure">Project Structure</a></li>
<li><a href="#autoload-paths">Autoload paths</a></li>
<li><a href="#%24load-path">$LOAD_PATH</a></li>
<li>
<a href="#reloading">Reloading</a>

<ul>
<li><a href="#reloading-and-stale-objects">Reloading and Stale Objects</a></li>
<li><a href="#autoloading-when-the-application-boots">Autoloading when the application boots</a></li>
</ul>
</li>
<li><a href="#eager-loading">Eager Loading</a></li>
<li><a href="#single-table-inheritance">Single Table Inheritance</a></li>
<li><a href="#customizing-inflections">Customizing Inflections</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#rails-autoloaders">Rails.autoloaders</a></li>
<li><a href="#opting-out">Opting Out</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="introduction"><a class="anchorlink" href="#introduction">1 Introduction</a></h3><div class="info"><p>Esta guía documenta la carga automática en el modo <code>zeitwerk</code>, que es nuevo en Rails 6. Si en su lugar desea leer sobre el modo <code>clásico</code>, consulte <a href="autoloading_and_reloading_constants_classic_mode.html">Constantes de carga y recarga automática (modo clásico)</a>.</p></div><p>En un programa de Ruby normal, las dependencias deben cargarse a mano. Por ejemplo, el siguiente controlador usa las clases <code>ApplicationController</code> y <code>Post</code>, y normalmente necesitarías poner llamadas <code>require</code> para ellas:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># DO NOT DO THIS.</span>
<span class="nb">require</span> <span class="s2">"application_controller"</span>
<span class="nb">require</span> <span class="s2">"post"</span>
<span class="c1"># DO NOT DO THIS.</span>

<span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# DO NOT DO THIS.
require "application_controller"
require "post"
# DO NOT DO THIS.

class PostsController &lt; ApplicationController
  def index
    @posts = Post.all
  end
end
'>Copy</button>
</div>
<p>Este no es el caso de las aplicaciones Rails, donde las clases de aplicaciones y los módulos están disponibles en todas partes:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PostsController &lt; ApplicationController
  def index
    @posts = Post.all
  end
end
">Copy</button>
</div>
<p>Las aplicaciones de Idiomatic Rails solo emiten llamadas <code>require</code> para cargar cosas desde su directorio <code>lib</code>, la biblioteca estándar de Ruby, gemas Ruby, etc. Es decir, cualquier cosa que no pertenezca a sus rutas de carga automática, explicadas a continuación.</p><h3 id="enabling-zeitwerk-mode"><a class="anchorlink" href="#enabling-zeitwerk-mode">2 Enabling Zeitwerk Mode</a></h3><p>El modo de carga automática <code>zeitwerk</code> está habilitado de forma predeterminada en las aplicaciones de Rails 6 que se ejecutan en CRuby:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span> <span class="c1"># enables zeitwerk mode in CRuby</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/application.rb
config.load_defaults 6.0 # enables zeitwerk mode in CRuby
">Copy</button>
</div>
<p>En el modo <code>zeitwerk</code>, Rails usa <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a> internamente para autocargar, recargar y cargar ansioso. Rails crea una instancia y configura una instancia dedicada de Zeitwerk que administra el proyecto.</p><div class="info"><p>No se configura Zeitwerk manualmente en una aplicación Rails. En su lugar, configura la aplicación utilizando los puntos de configuración portátiles que se explican en esta guía, y Rails lo traduce a Zeitwerk en su nombre.</p></div><h3 id="project-structure"><a class="anchorlink" href="#project-structure">3 Project Structure</a></h3><p>En una aplicación Rails, los nombres de los archivos deben coincidir con las constantes que definen, y los directorios actúan como espacios de nombres.</p><p>Por ejemplo, el archivo <code>app/helpers/users_helper.rb</code> debe definir <code>UsersHelper</code> y el archivo <code>app/controllers/admin/payments_controller.rb</code> debe definir <code>Admin::PaymentsController</code>.</p><p>De forma predeterminada, Rails configura Zeitwerk para declinar los nombres de los archivos con <code>String#camelize</code>. Por ejemplo, espera que <code>app/controllers/users_controller.rb</code> defina el constante <code>UsersController</code> porque</p><div class="code_container">
<pre><code class="highlight ruby"><span class="s2">"users_controller"</span><span class="p">.</span><span class="nf">camelize</span> <span class="c1"># =&gt; UsersController</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='"users_controller".camelize # =&gt; UsersController
'>Copy</button>
</div>
<p>La sección <em>Personalización de inflexiones</em> a continuación documenta las formas de anular este valor predeterminado.</p><p>Por favor, consulte la <a href="https://github.com/fxn/zeitwerk#file-structure">documentación de Zeitwerk</a> para obtener más detalles.</p><h3 id="autoload-paths"><a class="anchorlink" href="#autoload-paths">4 Autoload paths</a></h3><p>Nos referimos a la lista de directorios de aplicaciones cuyo contenido se va a cargar automáticamente como <em>rutas de carga automática</em>. Por ejemplo, <code>app/models</code>. Dichos directorios representan el espacio de nombres raíz: <code>Object</code>.</p><div class="info"><p>Las rutas de carga automática se denominan <em>directorios raíz</em> en la documentación de Zeitwerk, pero nos quedaremos con la "ruta de carga automática" en esta guía.</p></div><p>Dentro de una ruta de carga automática, los nombres de los archivos deben coincidir con las constantes que definen como se documenta <a href="https://github.com/fxn/zeitwerk#file-structure">aquí</a>.</p><p>De forma predeterminada, las rutas de carga automática de una aplicación constan de todos los subdirectorios de <code>app</code> que existen cuando la aplicación arranca --- excepto para <code>assets</code>, <code>javascript</code>, <code>views</code>, --- más las rutas de carga automática de los motores podría depender.</p><p>Por ejemplo, si <code>UsersHelper</code> está implementado en <code>app/helpers/users_helper.rb</code>, el módulo se puede autocargar, no necesitas (y no debes escribir) una llamada <code>require</code> para ello:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>runner <span class="s1">'p UsersHelper'</span>
<span class="go">UsersHelper
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails runner 'p UsersHelper'
">Copy</button>
</div>
<p>Las rutas de carga automática eligen automáticamente cualquier directorio personalizado en la <code>app</code>. Por ejemplo, si su aplicación tiene <code>aplicación/presentadores</code>, o <code>aplicación/servicios</code>, etc., se agregan a las rutas de carga automática.</p><p>La matriz de rutas de carga automática se puede ampliar mutando <code>config.autoload_paths</code>, en <code>config/application.rb</code>, pero hoy en día esto no se recomienda.</p><div class="warning"><p>Por favor, no mute <code>ActiveSupport::Dependencies.autoload_paths</code>, la interfaz pública para cambiar las rutas de carga automática es <code>config.autoload_paths</code>.</p></div><h3 id="$load-path"><a class="anchorlink" href="#%24load-path">5 $LOAD_PATH</a></h3><p>Las rutas de carga automática se agregan a <code>$LOAD_PATH</code> de forma predeterminada. Sin embargo, Zeitwerk usa nombres de archivo absolutos internamente, y su aplicación no debería emitir llamadas <code>require</code> para archivos autocargables, por lo que esos directorios en realidad no son necesarios allí. Puede optar por no participar con esta bandera:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.add_autoload_paths_to_load_path = false
">Copy</button>
</div>
<p>Eso puede acelerar un poco las llamadas legítimas <code>require</code>, ya que hay menos búsquedas. Además, si su aplicación usa <a href="https://github.com/Shopify/bootsnap">Bootsnap</a>, eso evita que la biblioteca cree índices innecesarios y guarda la RAM que necesitarían.</p><h3 id="reloading"><a class="anchorlink" href="#reloading">6 Reloading</a></h3><p>Rails recarga automáticamente clases y módulos si cambian los archivos de la aplicación.</p><p>Más precisamente, si el servidor web se está ejecutando y los archivos de la aplicación se han modificado, Rails descarga todas las constantes cargadas automáticamente justo antes de que se procese la siguiente solicitud. De esa manera, las clases de aplicación o los módulos utilizados durante esa solicitud se cargarán automáticamente, recogiendo así su implementación actual en el sistema de archivos.</p><p>La recarga se puede habilitar o deshabilitar. La configuración que controla este comportamiento es <code>config.cache_classes</code>, que es falsa de forma predeterminada en el modo de<code>develop</code> (recarga habilitada) y verdadera de forma predeterminada en el modo de <code>production</code> (recarga deshabilitada).</p><p>Rails detecta que los archivos han cambiado usando un monitor de archivos de eventos (predeterminado) o recorriendo las rutas de carga automática, dependiendo de <code>config.file_watcher</code>.</p><p>En una consola Rails no hay ningún observador de archivos activo independientemente del valor de <code>config.cache_classes</code>. Esto se debe a que, normalmente, sería confuso tener el código recargado en medio de una sesión de consola, de la misma manera que generalmente desea que una solicitud individual sea atendida por un conjunto consistente y sin cambios de clases y módulos de aplicación.</p><p>Sin embargo, puede forzar una recarga en la consola ejecutando <code>reload!</code>:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>c
<span class="go">Loading development environment (Rails 6.0.0)
</span><span class="gp">irb(main):001:0&gt;</span><span class="w"> </span>User.object_id
<span class="gp">=&gt;</span><span class="w"> </span>70136277390120
<span class="gp">irb(main):002:0&gt;</span><span class="w"> </span>reload!
<span class="go">Reloading...
</span><span class="gp">=&gt;</span><span class="w"> </span><span class="nb">true</span>
<span class="gp">irb(main):003:0&gt;</span><span class="w"> </span>User.object_id
<span class="gp">=&gt;</span><span class="w"> </span>70136284426020
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails c
">Copy</button>
</div>
<p>como puede ver, el objeto de clase almacenado en la constante <code>User</code> es diferente después de la recarga.</p><h4 id="reloading-and-stale-objects"><a class="anchorlink" href="#reloading-and-stale-objects">6.1 Reloading and Stale Objects</a></h4><p>Es muy importante entender que Ruby no tiene una forma de recargar realmente clases y módulos en la memoria, y eso se refleja en todos los lugares donde ya se usan. Técnicamente, "descargar" la clase <code>User</code> significa eliminar la constante <code>User</code> a través de <code>Object.send(:remove_const, "User")</code>.</p><p>Por lo tanto, el código que hace referencia a una clase o módulo recargable, pero que no se ejecuta de nuevo al recargar, se vuelve obsoleto. Veamos un ejemplo a continuación.</p><p>Consideremos este inicializador:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/configure_payment_gateway.rb</span>
<span class="c1"># DO NOT DO THIS.</span>
<span class="vg">$PAYMENT_GATEWAY</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span> <span class="p">?</span> <span class="no">RealGateway</span> <span class="p">:</span> <span class="no">MockedGateway</span>
<span class="c1"># DO NOT DO THIS.</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/configure_payment_gateway.rb
# DO NOT DO THIS.
$PAYMENT_GATEWAY = Rails.env.production? ? RealGateway : MockedGateway
# DO NOT DO THIS.
">Copy</button>
</div>
<p>La idea sería usar <code>$PAYMENT_GATEWAY</code> en el código, y dejar que el inicializador lo establezca en la implementación real que depende del entorno.</p><p>En la recarga, <code>MockedGateway</code> se vuelve a cargar, pero <code>$PAYMENT_GATEWAY</code> no se actualiza porque los inicializadores solo se ejecutan al arrancar. Por lo tanto, no reflejará los cambios.</p><p>Hay varias formas de hacer esto de forma segura. Por ejemplo, la aplicación podría definir un método de clase <code>PaymentGateway.impl</code> cuya definición depende del entorno; o podría definir "PaymentGateway" para tener una clase principal o mixin que depende del entorno; o use el mismo truco de variable global, pero en una devolución de llamada del recargador, como se explica a continuación.</p><p>Veamos otras situaciones que involucran objetos obsoletos de clase o módulo.</p><p>Consulta esta sesión de la consola de Rails:</p><div class="code_container">
<pre><code class="highlight plaintext">&gt; joe = User.new
&gt; reload!
&gt; alice = User.new
&gt; joe.class == alice.class
false
</code></pre>
<button class="clipboard-button" data-clipboard-text="&gt; joe = User.new
&gt; reload!
&gt; alice = User.new
&gt; joe.class == alice.class
false
">Copy</button>
</div>
<p><code>joe</code> es una instancia de la clase <code>User</code> original. Cuando hay una recarga, la constante <code>User</code> se evalúa como una clase recargada diferente. <code>alice</code> es una instancia del actual, pero <code>joe</code> no lo es, su clase está obsoleta. Puede definir <code>joe</code> nuevamente, iniciar una subsesión de IRB o simplemente iniciar una nueva consola en lugar de llamar a <code>reload!</code>.</p><p>Otra situación en la que puede encontrar este problema es subclasificar clases recargables en un lugar que no se recarga:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># lib/vip_user.rb</span>
<span class="k">class</span> <span class="nc">VipUser</span> <span class="o">&lt;</span> <span class="no">User</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# lib/vip_user.rb
class VipUser &lt; User
end
">Copy</button>
</div>
<p>si se vuelve a cargar <code>User</code>, ya que <code>VipUser</code> no lo es, la superclase de <code>VipUser</code> es el objeto de clase obsoleto original.</p><p>En pocas palabras: <strong>no guarde en caché clases o módulos recargables</strong>.</p><h4 id="autoloading-when-the-application-boots"><a class="anchorlink" href="#autoloading-when-the-application-boots">6.2 Autoloading when the application boots</a></h4><p>Las aplicaciones pueden cargar automáticamente constantes durante el arranque mediante una devolución de llamada del cargador:</p><div class="code_container">
<pre><code class="highlight plaintext">Rails.application.reloader.to_prepare do
  $PAYMENT_GATEWAY = Rails.env.production? ? RealGateway : MockedGateway
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.reloader.to_prepare do
  $PAYMENT_GATEWAY = Rails.env.production? ? RealGateway : MockedGateway
end
">Copy</button>
</div>
<p>Ese bloque se ejecuta cuando se inicia la aplicación y cada vez que se vuelve a cargar el código.</p><div class="note"><p>Por razones históricas, esta devolución de llamada puede ejecutarse dos veces. El código que ejecuta debe ser idempotente.</p></div><h3 id="eager-loading"><a class="anchorlink" href="#eager-loading">7 Eager Loading</a></h3><p>En entornos de producción, generalmente es mejor cargar todo el código de la aplicación cuando se inicia la aplicación. La carga ansiosa pone todo en la memoria listo para atender solicitudes de inmediato, y también es compatible con <a href="https://en.wikipedia.org/wiki/Copy-on-write">CoW</a>.</p><p>La carga ansiosa está controlada por la bandera <code>config.eager_load</code>, que está habilitada por defecto en el modo <code>producción</code>.</p><p>El orden en el que se cargan los archivos no está definido.</p><p>si la constante <code>Zeitwerk</code> está definida, Rails invoca <code>Zeitwerk::Loader.eager_load_all</code> independientemente del modo de carga automática de la aplicación. Eso asegura que las dependencias administradas por Zeitwerk estén cargadas con entusiasmo.</p><h3 id="single-table-inheritance"><a class="anchorlink" href="#single-table-inheritance">8 Single Table Inheritance</a></h3><p>La herencia de tabla única es una función que no funciona bien con la carga diferida. La razón es que su API generalmente necesita poder enumerar la jerarquía STI para que funcione correctamente, mientras que la carga diferida difiere la carga de clases hasta que se hace referencia a ellas. No puede enumerar lo que aún no ha hecho referencia.</p><p>En cierto sentido, las aplicaciones necesitan ansiosamente cargar las jerarquías de STI independientemente del modo de carga.</p><p>Por supuesto, si la aplicación se carga ansiosamente al arrancar, eso ya está logrado. Cuando no es así, en la práctica es suficiente instanciar los tipos existentes en la base de datos, lo que en los modos de desarrollo o prueba suele estar bien. Una forma de hacerlo es lanzar este módulo al directorio <code>lib</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">StiPreload</span>
  <span class="k">unless</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">eager_load</span>
    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

    <span class="n">included</span> <span class="k">do</span>
      <span class="n">cattr_accessor</span> <span class="ss">:preloaded</span><span class="p">,</span> <span class="ss">instance_accessor: </span><span class="kp">false</span>
    <span class="k">end</span>

    <span class="n">class_methods</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">descendants</span>
        <span class="n">preload_sti</span> <span class="k">unless</span> <span class="n">preloaded</span>
        <span class="k">super</span>
      <span class="k">end</span>

      <span class="c1"># Constantizes all types present in the database. There might be more on</span>
      <span class="c1"># disk, but that does not matter in practice as far as the STI API is</span>
      <span class="c1"># concerned.</span>
      <span class="c1">#</span>
      <span class="c1"># Assumes store_full_sti_class is true, the default.</span>
      <span class="k">def</span> <span class="nf">preload_sti</span>
        <span class="n">types_in_db</span> <span class="o">=</span> <span class="p">\</span>
          <span class="n">base_class</span><span class="p">.</span>
            <span class="nf">unscoped</span><span class="p">.</span>
            <span class="nf">select</span><span class="p">(</span><span class="n">inheritance_column</span><span class="p">).</span>
            <span class="nf">distinct</span><span class="p">.</span>
            <span class="nf">pluck</span><span class="p">(</span><span class="n">inheritance_column</span><span class="p">).</span>
            <span class="nf">compact</span>

        <span class="n">types_in_db</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">type</span><span class="o">|</span>
          <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s2">"Preloading STI type </span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
          <span class="n">type</span><span class="p">.</span><span class="nf">constantize</span>
        <span class="k">end</span>

        <span class="nb">self</span><span class="p">.</span><span class="nf">preloaded</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module StiPreload
  unless Rails.application.config.eager_load
    extend ActiveSupport::Concern

    included do
      cattr_accessor :preloaded, instance_accessor: false
    end

    class_methods do
      def descendants
        preload_sti unless preloaded
        super
      end

      # Constantizes all types present in the database. There might be more on
      # disk, but that does not matter in practice as far as the STI API is
      # concerned.
      #
      # Assumes store_full_sti_class is true, the default.
      def preload_sti
        types_in_db = \
          base_class.
            unscoped.
            select(inheritance_column).
            distinct.
            pluck(inheritance_column).
            compact

        types_in_db.each do |type|
          logger.debug("Preloading STI type #{type}")
          type.constantize
        end

        self.preloaded = true
      end
    end
  end
end
'>Copy</button>
</div>
<p>y luego inclúyalo en las clases raíz STI de su proyecto:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/shape.rb</span>
<span class="nb">require</span> <span class="s2">"sti_preload"</span>

<span class="k">class</span> <span class="nc">Shape</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">StiPreload</span> <span class="c1"># Only in the root class.</span>
<span class="k">end</span>

<span class="c1"># app/models/polygon.rb</span>
<span class="k">class</span> <span class="nc">Polygon</span> <span class="o">&lt;</span> <span class="no">Shape</span>
<span class="k">end</span>

<span class="c1"># app/models/triangle.rb</span>
<span class="k">class</span> <span class="nc">Triangle</span> <span class="o">&lt;</span> <span class="no">Polygon</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# app/models/shape.rb
require "sti_preload"

class Shape &lt; ApplicationRecord
  include StiPreload # Only in the root class.
end

# app/models/polygon.rb
class Polygon &lt; Shape
end

# app/models/triangle.rb
class Triangle &lt; Polygon
end
'>Copy</button>
</div>
<h3 id="customizing-inflections"><a class="anchorlink" href="#customizing-inflections">9 Customizing Inflections</a></h3><p>Por defecto, Rails usa <code>String#camelize</code> para saber qué constante debe definir un archivo o nombre de directorio dado. Por ejemplo, <code>posts_controller.rb</code> debería definir <code>PostsController</code> porque eso es lo que devuelve <code>"posts_controller".camelize</code>.</p><p>Podría darse el caso de que algún nombre de directorio o archivo en particular no se flexione como desea. Por ejemplo, se espera que <code>html_parser.rb</code> defina <code>HtmlParser</code> de forma predeterminada. ¿Qué pasa si prefiere que la clase sea <code>HTMLParser</code>? Hay algunas formas de personalizar esto.</p><p>La forma más sencilla es definir acrónimos en <code>config/initializers/inflections.rb</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Inflector</span><span class="p">.</span><span class="nf">inflections</span><span class="p">(</span><span class="ss">:en</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
  <span class="n">inflect</span><span class="p">.</span><span class="nf">acronym</span> <span class="s2">"HTML"</span>
  <span class="n">inflect</span><span class="p">.</span><span class="nf">acronym</span> <span class="s2">"SSL"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='ActiveSupport::Inflector.inflections(:en) do |inflect|
  inflect.acronym "HTML"
  inflect.acronym "SSL"
end
'>Copy</button>
</div>
<p>Si lo hace, afectará a la forma en que Active Support se flexiona globalmente. Eso puede estar bien en algunas aplicaciones, pero también puede personalizar cómo camelizar nombres de base individuales independientemente de Active Support pasando una colección de anulaciones a los inflectores predeterminados:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/zeitwerk.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">autoloader</span><span class="o">|</span>
  <span class="n">autoloader</span><span class="p">.</span><span class="nf">inflector</span><span class="p">.</span><span class="nf">inflect</span><span class="p">(</span>
    <span class="s2">"html_parser"</span> <span class="o">=&gt;</span> <span class="s2">"HTMLParser"</span><span class="p">,</span>
    <span class="s2">"ssl_error"</span>   <span class="o">=&gt;</span> <span class="s2">"SSLError"</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/initializers/zeitwerk.rb
Rails.autoloaders.each do |autoloader|
  autoloader.inflector.inflect(
    "html_parser" =&gt; "HTMLParser",
    "ssl_error"   =&gt; "SSLError"
  )
end
'>Copy</button>
</div>
<p>Sin embargo, esa técnica todavía depende de <code>String#camelize</code>, porque eso es lo que los inflectores predeterminados usan como respaldo. Si en cambio prefiere no depender de las inflexiones de Active Support y tener un control absoluto sobre las inflexiones, configure los inflectores para que sean instancias de <code>Zeitwerk::Inflector</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/zeitwerk.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">autoloader</span><span class="o">|</span>
  <span class="n">autoloader</span><span class="p">.</span><span class="nf">inflector</span> <span class="o">=</span> <span class="no">Zeitwerk</span><span class="o">::</span><span class="no">Inflector</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">autoloader</span><span class="p">.</span><span class="nf">inflector</span><span class="p">.</span><span class="nf">inflect</span><span class="p">(</span>
    <span class="s2">"html_parser"</span> <span class="o">=&gt;</span> <span class="s2">"HTMLParser"</span><span class="p">,</span>
    <span class="s2">"ssl_error"</span>   <span class="o">=&gt;</span> <span class="s2">"SSLError"</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/initializers/zeitwerk.rb
Rails.autoloaders.each do |autoloader|
  autoloader.inflector = Zeitwerk::Inflector.new
  autoloader.inflector.inflect(
    "html_parser" =&gt; "HTMLParser",
    "ssl_error"   =&gt; "SSLError"
  )
end
'>Copy</button>
</div>
<p>No existe una configuración global que pueda afectar a dichas instancias, son deterministas.</p><p>Incluso puede definir un inflector personalizado para una flexibilidad total. Por favor, consulte la <a href="https://github.com/fxn/zeitwerk#custom-inflector">documentación de Zeitwerk</a> para obtener más detalles.</p><h3 id="troubleshooting"><a class="anchorlink" href="#troubleshooting">10 Troubleshooting</a></h3><p>La mejor forma de seguir lo que están haciendo los cargadores es inspeccionar su actividad.</p><p>La forma más sencilla de hacerlo es lanzar</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">log!</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.log!
">Copy</button>
</div>
<p>a <code>config/application.rb</code> después de cargar los valores predeterminados del marco. Eso imprimirá trazas en la salida estándar.</p><p>Si prefiere iniciar sesión en un archivo, configure esto en su lugar:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/log/autoloading.log"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Rails.autoloaders.logger = Logger.new("#{Rails.root}/log/autoloading.log")
'>Copy</button>
</div>
<p>El registrador Rails todavía no está listo en <code>config/application.rb</code>, pero está en inicializadores:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/log_autoloaders.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/log_autoloaders.rb
Rails.autoloaders.logger = Rails.logger
">Copy</button>
</div>
<h3 id="rails-autoloaders"><a class="anchorlink" href="#rails-autoloaders">11 Rails.autoloaders</a></h3><p>Las instancias de Zeitwerk que administran su aplicación están disponibles en</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">once</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.main
Rails.autoloaders.once
">Copy</button>
</div>
<p>El primero es el principal. Este último está allí principalmente por razones de compatibilidad con versiones anteriores, en caso de que la aplicación tenga algo en <code>config.autoload_once_paths</code> (esto no se recomienda hoy en día).</p><p>Puede comprobar si el modo <code>zeitwerk</code> está habilitado con</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">zeitwerk_enabled?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.zeitwerk_enabled?
">Copy</button>
</div>
<h3 id="opting-out"><a class="anchorlink" href="#opting-out">12 Opting Out</a></h3><p>Las aplicaciones pueden cargar los valores predeterminados de Rails 6 y seguir usando el cargador automático clásico de esta manera:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:classic</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/application.rb
config.load_defaults 6.0
config.autoloader = :classic
">Copy</button>
</div>
<p>Eso puede ser útil si se actualiza a Rails 6 en diferentes fases, pero se desaconseja el modo clásico para nuevas aplicaciones.</p><p>El modo <code>zeitwerk</code> no está disponible en versiones de Rails anteriores a 6.0.</p>

        <h3>Comentarios Sobre el Contenido</h3>
        <p>
          Las guías de rieles se administran y publican en latinadeveloper/railsguides.es en GitHub.
        </p>
        <p>
          Si lee esta guía y encuentra algún texto o código incorrecto que le interese, no dude en enviar una solicitud de extracción en el repositorio anterior.

          Consulte el archivo README en GitHub para saber cómo enviar una solicitud de extracción.
          Please contribute if you see any typos or factual errors.
        </p>

      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </div>
</body>
</html>
