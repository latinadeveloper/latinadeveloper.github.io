<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Devolución (callbacks) de Llamadas de Active Record — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/prism/default.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/prism/rails-guides.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/prism.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/responsive-tables.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Devolución (callbacks) de Llamadas de Active Record — Ruby on Rails Guides" />
  <meta name="description" content="NO LEA ESTE ARCHIVO EN GITHUB, LAS GUÍAS SE PUBLICAN EN https://guides.rubyonrails.org.Devolución (callbacks) de Llamadas de Active RecordEsta guía le enseña cómo conectarse al ciclo de vida de su Registro Activo objetos.Después de leer esta guía, sabrá: El ciclo de vida de los objetos Active Record. Cómo crear métodos de devolución de llamada que respondan a eventos en el ciclo de vida del objeto. Cómo crear clases especiales que encapsulan un comportamiento común para sus devoluciones de llamada." />
  <meta property="og:description" content="NO LEA ESTE ARCHIVO EN GITHUB, LAS GUÍAS SE PUBLICAN EN https://guides.rubyonrails.org.Devolución (callbacks) de Llamadas de Active RecordEsta guía le enseña cómo conectarse al ciclo de vida de su Registro Activo objetos.Después de leer esta guía, sabrá: El ciclo de vida de los objetos Active Record. Cómo crear métodos de devolución de llamada que respondan a eventos en el ciclo de vida del objeto. Cómo crear clases especiales que encapsulan un comportamiento común para sus devoluciones de llamada." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
<!--    <img src="images/edge_badge.png" alt="edge-badge" id="edge-badge" />-->
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Más en <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Más Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guías</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://stackoverflow.com/questions/tagged/ruby-on-rails">Pedir Ayuda</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribuir on GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Guías de Ruby on Rails">Guías de Ruby on Rails </a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Inicio</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Index de Guías </a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>Empieza Aqui</dt>
                  <dd><a href="getting_started.html">Introducción a Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Modelos</dt>
                  <dd><a href="active_record_basics.html">Conceptos básicos de Active Record</a></dd>
                  <dd><a href="active_record_migrations.html">Migraciones de Active Record</a></dd>
                  <dd><a href="active_record_validations.html">Validaciones de Active Record</a></dd>
                  <dd><a href="active_record_callbacks.html">Devolución (callbacks) de Llamadas de Active Record</a></dd>
                  <dd><a href="association_basics.html">Asociaciones de Active Record</a></dd>
                  <dd><a href="active_record_querying.html">Interfaz de Consulta de Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Vistas</dt>
                  <dd><a href="layouts_and_rendering.html">Diseños y Renderizado en Rails</a></dd>
                  <dd><a href="form_helpers.html">Ayudantes de Formulario de Action</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controladores</dt>
                  <dd><a href="action_controller_overview.html">Descripción General de Action Controller</a></dd>
                  <dd><a href="routing.html">Rails Routing Desde el Exterior Hacia Adentro</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Otros Componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Extensiones de Núcleo de Active Support</a></dd>
                  <dd><a href="action_mailer_basics.html">Conceptos Básicos de Action Mailer</a></dd>
                  <dd><a href="active_job_basics.html">Conceptos Básicos de Active Job</a></dd>
                  <dd><a href="active_storage_overview.html">Descripción General de Active Storage</a></dd>
                  <dd><a href="action_cable_overview.html">Descripción General de Action Cable</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Temas Avanzados</dt>
                  <dd><a href="i18n.html">Rails API de Internacionalización (I18n)</a></dd>
                  <dd><a href="testing.html">Prueba de Aplicaciones de Rails</a></dd>
                  <dd><a href="security.html">Seguridad de Aplicaciones Rails</a></dd>
                  <dd><a href="debugging_rails_applications.html">Depuración de Applications Rails</a></dd>
                  <dd><a href="configuring.html">Configuración de Aplicaciones de Rails</a></dd>
                  <dd><a href="command_line.html">La Línea de Comandos de Rails</a></dd>
                  <dd><a href="asset_pipeline.html">La Canalización de Activos (necesita traducción)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Constantes de Autocarga y Recarga (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Constantes de Autocarga y Recarga (modo clásico)</a></dd>
                  <dd><a href="caching_with_rails.html">Almacenamiento en Caché con Rails Descripción General</a></dd>
                  <dd><a href="api_app.html">Uso de Rails para Aplicaciones Solo API</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Extending Rails  (toda la sección necesita traducción)</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribuir</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guides Index</option>
              <optgroup label="Empieza Aqui">
                  <option value="getting_started.html">Introducción a Rails</option>
              </optgroup>
              <optgroup label="Modelos">
                  <option value="active_record_basics.html">Conceptos básicos de Active Record</option>
                  <option value="active_record_migrations.html">Migraciones de Active Record</option>
                  <option value="active_record_validations.html">Validaciones de Active Record</option>
                  <option value="active_record_callbacks.html">Devolución (callbacks) de Llamadas de Active Record</option>
                  <option value="association_basics.html">Asociaciones de Active Record</option>
                  <option value="active_record_querying.html">Interfaz de Consulta de Active Record</option>
              </optgroup>
              <optgroup label="Vistas">
                  <option value="layouts_and_rendering.html">Diseños y Renderizado en Rails</option>
                  <option value="form_helpers.html">Ayudantes de Formulario de Action</option>
              </optgroup>
              <optgroup label="Controladores">
                  <option value="action_controller_overview.html">Descripción General de Action Controller</option>
                  <option value="routing.html">Rails Routing Desde el Exterior Hacia Adentro</option>
              </optgroup>
              <optgroup label="Otros Componentes">
                  <option value="active_support_core_extensions.html">Extensiones de Núcleo de Active Support</option>
                  <option value="action_mailer_basics.html">Conceptos Básicos de Action Mailer</option>
                  <option value="active_job_basics.html">Conceptos Básicos de Active Job</option>
                  <option value="active_storage_overview.html">Descripción General de Active Storage</option>
                  <option value="action_cable_overview.html">Descripción General de Action Cable</option>
              </optgroup>
              <optgroup label="Temas Avanzados">
                  <option value="i18n.html">Rails API de Internacionalización (I18n)</option>
                  <option value="testing.html">Prueba de Aplicaciones de Rails</option>
                  <option value="security.html">Seguridad de Aplicaciones Rails</option>
                  <option value="debugging_rails_applications.html">Depuración de Applications Rails</option>
                  <option value="configuring.html">Configuración de Aplicaciones de Rails</option>
                  <option value="command_line.html">La Línea de Comandos de Rails</option>
                  <option value="asset_pipeline.html">La Canalización de Activos (necesita traducción)</option>
                  <option value="autoloading_and_reloading_constants.html">Constantes de Autocarga y Recarga (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Constantes de Autocarga y Recarga (modo clásico)</option>
                  <option value="caching_with_rails.html">Almacenamiento en Caché con Rails Descripción General</option>
                  <option value="api_app.html">Uso de Rails para Aplicaciones Solo API</option>
              </optgroup>
              <optgroup label="Extending Rails  (toda la sección necesita traducción)">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <p><strong>NO LEA ESTE ARCHIVO EN GITHUB, LAS GUÍAS SE PUBLICAN EN <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p><h2>Devolución (callbacks) de Llamadas de Active Record</h2><p>Esta guía le enseña cómo conectarse al ciclo de vida de su Registro Activo
objetos.</p><p>Después de leer esta guía, sabrá:</p>
<ul>
<li>El ciclo de vida de los objetos Active Record.</li>
<li>Cómo crear métodos de devolución de llamada que respondan a eventos en el ciclo de vida del objeto.</li>
<li>Cómo crear clases especiales que encapsulan un comportamiento común para sus devoluciones de llamada.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#the-object-life-cycle">The Object Life Cycle</a></li>
<li><a href="#callbacks-overview">Callbacks Overview</a></li>
<li>
<a href="#available-callbacks">Available Callbacks</a>

<ul>
<li><a href="#creating-an-object">Creating an Object</a></li>
<li><a href="#updating-an-object">Updating an Object</a></li>
<li><a href="#destroying-an-object">Destroying an Object</a></li>
<li><a href="#after-initialize-and-after-find"><code>after_initialize</code> and <code>after_find</code></a></li>
<li><a href="#after-touch"><code>after_touch</code></a></li>
</ul>
</li>
<li><a href="#running-callbacks">Running Callbacks</a></li>
<li><a href="#skipping-callbacks">Skipping Callbacks</a></li>
<li><a href="#halting-execution">Halting Execution</a></li>
<li>
<a href="#conditional-callbacks">Conditional Callbacks</a>

<ul>
<li><a href="#using-if-and-unless-with-a-symbol">Using <code>:if</code> and <code>:unless</code> with a <code>Symbol</code></a></li>
<li><a href="#using-if-and-unless-with-a-proc">Using <code>:if</code> and <code>:unless</code> with a <code>Proc</code></a></li>
<li><a href="#multiple-conditions-for-callbacks">Multiple Conditions for Callbacks</a></li>
<li><a href="#combining-callback-conditions">Combining Callback Conditions</a></li>
</ul>
</li>
<li><a href="#callback-classes">Callback Classes</a></li>
<li><a href="#transaction-callbacks">Transaction Callbacks</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="the-object-life-cycle"><a class="anchorlink" href="#the-object-life-cycle">1 The Object Life Cycle</a></h3><p>El Ciclo de Vida del Objeto</p><p>Durante el funcionamiento normal de una aplicación de Rails, se pueden crear, actualizar y destruir los objetos. Active Record proporciona ganchos en este <em>object life cycle</em> para que pueda controlar su aplicación y sus datos.</p><p>Las devoluciones de llamada le permiten activar la lógica antes o después de una alteración del estado de un objeto.</p><h3 id="callbacks-overview"><a class="anchorlink" href="#callbacks-overview">2 Callbacks Overview</a></h3><p>Descripción General de Devoluciones de Llamada</p><p>Las devoluciones de llamada son métodos que se llaman en ciertos momentos del ciclo de vida de un objeto. Con las devoluciones de llamada, es posible escribir código que se ejecutará siempre que se cree, guarde, actualice, elimine, valide o cargue un objeto Active Record desde la base de datos.</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  validates :login, :email, presence: true

  before_validation :ensure_login_has_a_value

  private
    def ensure_login_has_a_value
      if login.nil?
        self.login = email unless email.blank?
      end
    end
end
</code></pre>
</div>
<p>Los métodos de clase de estilo macro también pueden recibir un bloque. Considere usar este estilo si el código dentro de su bloque es tan corto que cabe en una sola línea:</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  validates :login, :email, presence: true

  before_create do
    self.name = login.capitalize if name.blank?
  end
end
</code></pre>
</div>
<p>Las devoluciones de llamada también se pueden registrar para que solo se activen en ciertos eventos del ciclo de vida:</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  before_validation :normalize_name, on: :create

  # :on takes an array as well
  after_validation :set_location, on: [ :create, :update ]

  private
    def normalize_name
      self.name = name.downcase.titleize
    end

    def set_location
      self.location = LocationService.query(self)
    end
end
</code></pre>
</div>
<p>Se considera una buena práctica declarar los métodos de devolución de llamada como privados. Si se dejan públicos, se pueden llamar desde fuera del modelo y violan el principio de encapsulación de objetos.</p><h3 id="available-callbacks"><a class="anchorlink" href="#available-callbacks">3 Available Callbacks</a></h3><p>Callbacks Disponibles</p><p>Aquí hay una lista con todas las devoluciones de llamada de Active Record disponibles, enumeradas en el mismo orden en que se las llamará durante las respectivas operaciones:</p><h4 id="creating-an-object"><a class="anchorlink" href="#creating-an-object">3.1 Creating an Object</a></h4>
<ul>
<li><code>before_validation</code></li>
<li><code>after_validation</code></li>
<li><code>before_save</code></li>
<li><code>around_save</code></li>
<li><code>before_create</code></li>
<li><code>around_create</code></li>
<li><code>after_create</code></li>
<li><code>after_save</code></li>
<li><code>after_commit/after_rollback</code></li>
</ul>
<h4 id="updating-an-object"><a class="anchorlink" href="#updating-an-object">3.2 Updating an Object</a></h4>
<ul>
<li><code>before_validation</code></li>
<li><code>after_validation</code></li>
<li><code>before_save</code></li>
<li><code>around_save</code></li>
<li><code>before_update</code></li>
<li><code>around_update</code></li>
<li><code>after_update</code></li>
<li><code>after_save</code></li>
<li><code>after_commit/after_rollback</code></li>
</ul>
<h4 id="destroying-an-object"><a class="anchorlink" href="#destroying-an-object">3.3 Destroying an Object</a></h4>
<ul>
<li><code>before_destroy</code></li>
<li><code>around_destroy</code></li>
<li><code>after_destroy</code></li>
<li><code>after_commit/after_rollback</code></li>
</ul>
<p>ADVERTENCIA. <code>after_save</code> se ejecuta tanto en crear como en actualizar, pero siempre <em>after</em> de las devoluciones de llamada más específicas <code>after_create</code> y <code>after_update</code>, sin importar el orden en que se ejecutaron las llamadas macro.</p><p>ADVERTENCIA. Se debe tener cuidado en las devoluciones de llamada para evitar actualizar los atributos. Por ejemplo, evite ejecutar <code>update(attribute: "value")</code>  y un código similar durante las devoluciones de llamada. Esto puede alterar el estado del modelo y puede provocar efectos secundarios inesperados durante la confirmación. En su lugar, debe intentar asignar valores en las devoluciones de llamada <code>before_create</code> o anteriores.</p><p>NOTA: las devoluciones de llamada <code>before_destroy</code> deben colocarse antes de las asociaciones  <code>dependent: :destroy</code>
(o use la opción <code>prepend: true</code>), para asegurarse de que se ejecuten antes que
los registros sean eliminados por <code>dependent: :destroy</code>.</p><h4 id="after-initialize-and-after-find"><a class="anchorlink" href="#after-initialize-and-after-find">3.4 <code>after_initialize</code> and <code>after_find</code></a></h4><p>La devolución de llamada <code>after_initialize</code> se llamará siempre que se cree una instancia de un objeto Active Record, ya sea utilizando directamente <code>new</code> o cuando se carga un registro desde la base de datos. Puede ser útil para evitar la necesidad de anular directamente el método de <code>initialize</code> de Active Record.</p><p>La devolución de llamada <code>after_find</code> se llamará siempre que Active Record cargue un registro de la base de datos. <code>after_find</code> se llama antes de<code>after_initialize</code> si ambos están definidos.</p><p>La devolución de llamada <code>after_initialize</code> y<code>after_find</code> no tienen contrapartidas <code>before_ *</code>, pero pueden registrarse como las otras devoluciones de llamadas de Active Record.</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  after_initialize do |user|
    puts "You have initialized an object!"
  end

  after_find do |user|
    puts "You have found an object!"
  end
end

&gt;&gt; User.new
You have initialized an object!
=&gt; #&lt;User id: nil&gt;

&gt;&gt; User.first
You have found an object!
You have initialized an object!
=&gt; #&lt;User id: 1&gt;
</code></pre>
</div>
<h4 id="after-touch"><a class="anchorlink" href="#after-touch">3.5 <code>after_touch</code></a></h4><p>La devolución de llamada <code>after_touch</code> se llamará cada vez que se toque un objeto Active Record.</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  after_touch do |user|
    puts "You have touched an object"
  end
end

&gt;&gt; u = User.create(name: 'Kuldeep')
=&gt; #&lt;User id: 1, name: "Kuldeep", created_at: "2013-11-25 12:17:49", updated_at: "2013-11-25 12:17:49"&gt;

&gt;&gt; u.touch
You have touched an object
=&gt; true
</code></pre>
</div>
<p>It can be used along with <code>belongs_to</code>:</p><div class="code_container">
<pre><code class="language-ruby">class Employee &lt; ApplicationRecord
  belongs_to :company, touch: true
  after_touch do
    puts 'An Employee was touched'
  end
end

class Company &lt; ApplicationRecord
  has_many :employees
  after_touch :log_when_employees_or_company_touched

  private
    def log_when_employees_or_company_touched
      puts 'Employee/Company was touched'
    end
end

&gt;&gt; @employee = Employee.last
=&gt; #&lt;Employee id: 1, company_id: 1, created_at: "2013-11-25 17:04:22", updated_at: "2013-11-25 17:05:05"&gt;

# triggers @employee.company.touch
&gt;&gt; @employee.touch
An Employee was touched
Employee/Company was touched
=&gt; true
</code></pre>
</div>
<h3 id="running-callbacks"><a class="anchorlink" href="#running-callbacks">4 Running Callbacks</a></h3><p>Ejecutar Devoluciones de Llamada</p><p>Los siguientes métodos desencadenan las devoluciones de llamada:</p>
<ul>
<li><code>create</code></li>
<li><code>create!</code></li>
<li><code>destroy</code></li>
<li><code>destroy!</code></li>
<li><code>destroy_all</code></li>
<li><code>save</code></li>
<li><code>save!</code></li>
<li><code>save(validate: false)</code></li>
<li><code>toggle!</code></li>
<li><code>touch</code></li>
<li><code>update_attribute</code></li>
<li><code>update</code></li>
<li><code>update!</code></li>
<li><code>valid?</code></li>
</ul>
<p>Además, la devolución de llamada <code>after_find</code> se activa mediante los siguientes métodos de búsqueda:</p>
<ul>
<li><code>all</code></li>
<li><code>first</code></li>
<li><code>find</code></li>
<li><code>find_by</code></li>
<li><code>find_by_*</code></li>
<li><code>find_by_*!</code></li>
<li><code>find_by_sql</code></li>
<li><code>last</code></li>
</ul>
<p>La devolución de llamada <code>after_initialize</code> se activa cada vez que se inicializa un nuevo objeto de la clase.</p><p>NOTA: Los métodos <code>find_by_*</code> y <code>find_by_*!</code> son buscadores dinámicos generados automáticamente para cada atributo. Obtenga más información sobre ellos en la <a href="active_record_querying.html#dynamic-finders">Dynamic finders section</a></p><h3 id="skipping-callbacks"><a class="anchorlink" href="#skipping-callbacks">5 Skipping Callbacks</a></h3><p>Saltar Devoluciones de Llamada</p><p>Igual que con las validaciones, también es posible omitir devoluciones de llamada utilizando los siguientes métodos:</p>
<ul>
<li><code>decrement!</code></li>
<li><code>decrement_counter</code></li>
<li><code>delete</code></li>
<li><code>delete_all</code></li>
<li><code>increment!</code></li>
<li><code>increment_counter</code></li>
<li><code>update_column</code></li>
<li><code>update_columns</code></li>
<li><code>update_all</code></li>
<li><code>update_counters</code></li>
</ul>
<p>Sin embargo, estos métodos se deben usarse con precaución, ya que las reglas comerciales importantes y la lógica de la aplicación pueden mantenerse en devoluciones de llamada. Eludirlos sin comprender las posibles implicaciones puede conducir a datos no válidos.</p><h3 id="halting-execution"><a class="anchorlink" href="#halting-execution">6 Halting Execution</a></h3><p>Detener la Ejecución</p><p>Cuando comience a registrar nuevas devoluciones de llamada para sus modelos, se pondrán en cola para su ejecución. Esta cola incluirá todas las validaciones de su modelo, las devoluciones de llamada registradas y la operación de la base de datos que se ejecutará.</p><div class="code_container">
<pre><code class="language-ruby">throw :abort
</code></pre>
</div>
<p>ADVERTENCIA. Rails volverá a plantear cualquier excepción que no sea <code>ActiveRecord::Rollback</code> o<code>ActiveRecord::RecordInvalid</code> después de detener la cadena de devolución de llamada. Elevando una excepción que no sea <code>ActiveRecord::Rollback</code> o<code>ActiveRecord::RecordInvalid</code> puede romper el código que no espera métodos como <code>save</code> y <code>update</code> (que normalmente intentan devolver <code>true</code> o<code>false</code>) una excepción.</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  has_many :articles, dependent: :destroy
end

class Article &lt; ApplicationRecord
  after_destroy :log_destroy_action

  def log_destroy_action
    puts 'Article destroyed'
  end
end

&gt;&gt; user = User.first
=&gt; #&lt;User id: 1&gt;
&gt;&gt; user.articles.create!
=&gt; #&lt;Article id: 1, user_id: 1&gt;
&gt;&gt; user.destroy
Article destroyed
=&gt; #&lt;User id: 1&gt;
</code></pre>
</div>
<h3 id="conditional-callbacks"><a class="anchorlink" href="#conditional-callbacks">7 Conditional Callbacks</a></h3><p>Condicionales de Callbacks </p><p>Al igual que con las validaciones, también podemos condicionar la invocación de un método de devolución de llamada a la satisfacción de un predicado dado. Podemos hacer esto usando las opciones <code>:if</code> y <code>:unless</code>, que pueden tomar un símbolo, un <code>Proc</code> o un <code>Array</code>. Puede usar la opción <code>:if</code> cuando desee especificar en qué condiciones se debe llamar a la devolución de llamada <em>unless</em>. Si desea especificar las condiciones bajo las cuales no se debe llamar a la devolución de llamada <strong>should not</strong>, puede usar la opción <code>:unless</code></p><h4 id="using-if-and-unless-with-a-symbol"><a class="anchorlink" href="#using-if-and-unless-with-a-symbol">7.1 Using <code>:if</code> and <code>:unless</code> with a <code>Symbol</code></a></h4><p>Puede asociar las opciones <code>:if</code> y <code>:unlesss</code> con un símbolo correspondiente al nombre de un método de predicado que se llamará justo antes de la devolución de llamada. Cuando se usa la opción <code>:if</code>, la devolución de llamada no se ejecutará si el método de predicado devuelve falso; cuando se usa la opción <code>:unless</code>, la devolución de llamada no se ejecutará si el método de predicado devuelve verdadero. Esta es la opción más común. Al usar esta forma de registro, también es posible registrar varios predicados diferentes que se deben llamar para verificar si se debe ejecutar la devolución de llamada.</p><div class="code_container">
<pre><code class="language-ruby">class Order &lt; ApplicationRecord
  before_save :normalize_card_number, if: :paid_with_card?
end
</code></pre>
</div>
<h4 id="using-if-and-unless-with-a-proc"><a class="anchorlink" href="#using-if-and-unless-with-a-proc">7.2 Using <code>:if</code> and <code>:unless</code> with a <code>Proc</code></a></h4><p>Es posible asociar <code>:if</code> y <code>:unless</code> con un objeto <code>Proc</code>. Esta opción es más adecuada cuando se escriben métodos de validación cortos, generalmente de una sola línea:</p><div class="code_container">
<pre><code class="language-ruby">class Order &lt; ApplicationRecord
  before_save :normalize_card_number,
    if: Proc.new { |order| order.paid_with_card? }
end
</code></pre>
</div>
<p>Como el proceso se evalúa en el contexto del objeto, también es posible escribir esto como:</p><div class="code_container">
<pre><code class="language-ruby">class Order &lt; ApplicationRecord
  before_save :normalize_card_number, if: Proc.new { paid_with_card? }
end
</code></pre>
</div>
<h4 id="multiple-conditions-for-callbacks"><a class="anchorlink" href="#multiple-conditions-for-callbacks">7.3 Multiple Conditions for Callbacks</a></h4><p>Al escribir devoluciones de llamada condicionales, es posible mezclar tanto <code>:if</code> como <code>:unless</code> en la misma declaración de devolución de llamada:</p><div class="code_container">
<pre><code class="language-ruby">class Comment &lt; ApplicationRecord
  after_create :send_email_to_author, if: :author_wants_emails?,
    unless: Proc.new { |comment| comment.article.ignore_comments? }
end
</code></pre>
</div>
<h4 id="combining-callback-conditions"><a class="anchorlink" href="#combining-callback-conditions">7.4 Combining Callback Conditions</a></h4><p>Cuando varias condiciones definen si se debe realizar una devolución de llamada o no, se puede usar una 'Matriz'. Además, puede aplicar <code>: if</code> y <code>:unless</code> a la misma devolución de llamada.</p><div class="code_container">
<pre><code class="language-ruby">class Comment &lt; ApplicationRecord
  after_create :send_email_to_author,
    if: [Proc.new { |c| c.user.allow_send_email? }, :author_wants_emails?],
    unless: Proc.new { |c| c.article.ignore_comments? }
end
</code></pre>
</div>
<p>La devolución de llamada solo se ejecuta cuando todas las condiciones <code>:if</code> y ninguna de las condiciones<code>:unless</code> se evalúan como <code>true</code>.</p><h3 id="callback-classes"><a class="anchorlink" href="#callback-classes">8 Callback Classes</a></h3><p>Clases de Devolución de Llamada</p><p>A veces, los métodos de devolución de llamada que escribirá serán lo suficientemente útiles como para ser reutilizados por otros modelos. Active Record hace posible crear clases que encapsulan los métodos de devolución de llamada, para que puedan reutilizarse.</p><p>Aquí hay un ejemplo en el que creamos una clase con una devolución de llamada <code>after_destroy</code> para un modelo<code>PictureFile</code>:</p><div class="code_container">
<pre><code class="language-ruby">class PictureFileCallbacks
  def after_destroy(picture_file)
    if File.exist?(picture_file.filepath)
      File.delete(picture_file.filepath)
    end
  end
end
</code></pre>
</div>
<p>Cuando se declara dentro de una clase, como se indicó anteriormente, los métodos de devolución de llamada recibirán el objeto modelo como un parámetro. Ahora podemos usar la clase de devolución de llamada en el modelo:</p><div class="code_container">
<pre><code class="language-ruby">class PictureFile &lt; ApplicationRecord
  after_destroy PictureFileCallbacks.new
end
</code></pre>
</div>
<p>Tenga en cuenta que necesitábamos crear una instancia de un nuevo objeto <code>PictureFileCallbacks</code>, ya que declaramos nuestra devolución de llamada como método de instancia. Esto es particularmente útil si las devoluciones de llamada hacen uso del estado del objeto instanciado. Sin embargo, a menudo tendrá más sentido declarar las devoluciones de llamada como métodos de clase:</p><div class="code_container">
<pre><code class="language-ruby">class PictureFileCallbacks
  def self.after_destroy(picture_file)
    if File.exist?(picture_file.filepath)
      File.delete(picture_file.filepath)
    end
  end
end
</code></pre>
</div>
<p>Si el método de devolución de llamada se declara de esta manera, no será necesario instanciar un objeto <code>PictureFileCallbacks</code>.</p><div class="code_container">
<pre><code class="language-ruby">class PictureFile &lt; ApplicationRecord
  after_destroy PictureFileCallbacks
end
</code></pre>
</div>
<p>Puede declarar tantas devoluciones de llamada como desee dentro de sus clases de devolución de llamada.</p><h3 id="transaction-callbacks"><a class="anchorlink" href="#transaction-callbacks">9 Transaction Callbacks</a></h3><p>Callbacks de transacciones</p><p>Hay dos devoluciones de llamada adicionales que se activan al completar una transacción de base de datos: <code>after_commit</code> y <code>after_rollback</code>. Estas devoluciones de llamada son muy similares a la devolución de llamada <code>after_save</code>, excepto que no se ejecutan hasta después de que los cambios en la base de datos se hayan confirmado o revertido. Son más útiles cuando sus modelos de registros activos necesitan interactuar con sistemas externos que no forman parte de la transacción de la base de datos.</p><p>Considere, por ejemplo, el ejemplo anterior en el que el modelo <code>PictureFile</code> necesita eliminar un archivo después de que se destruya el registro correspondiente. Si algo genera una excepción después de que se llama la devolución de llamada <code>after_destroy</code> y la transacción se revierte, el archivo se habrá eliminado y el modelo quedará en un estado inconsistente. Por ejemplo, suponga que <code>picture_file_2</code> en el código a continuación no es válido y que el método <code>save!</code> genera un error.</p><div class="code_container">
<pre><code class="language-ruby">PictureFile.transaction do
  picture_file_1.destroy
  picture_file_2.save!
end
</code></pre>
</div>
<p>Al usar la devolución de llamada <code>after_commit</code> podemos dar cuenta de este caso.</p><div class="code_container">
<pre><code class="language-ruby">class PictureFile &lt; ApplicationRecord
  after_commit :delete_picture_file_from_disk, on: :destroy

  def delete_picture_file_from_disk
    if File.exist?(filepath)
      File.delete(filepath)
    end
  end
end
</code></pre>
</div>
<p>NOTA: La opción <code>:on</code> especifica cuándo se activará una devolución de llamada. Si tu
no proporcione la opción <code>:on</code>, la devolución de llamada se activará para cada acción.</p><p>Dado que el uso de la devolución de llamada <code>after_commit</code> solo en crear, actualizar o eliminar es
común, hay alias para esas operaciones:</p>
<ul>
<li><code>after_create_commit</code></li>
<li><code>after_update_commit</code></li>
<li><code>after_destroy_commit</code></li>
</ul>
<div class="code_container">
<pre><code class="language-ruby">class PictureFile &lt; ApplicationRecord
  after_destroy_commit :delete_picture_file_from_disk

  def delete_picture_file_from_disk
    if File.exist?(filepath)
      File.delete(filepath)
    end
  end
end
</code></pre>
</div>
<p>ADVERTENCIA. Cuando se completa una transacción, se llaman las devoluciones de llamada <code>after_commit</code> o<code>after_rollback</code> para todos los modelos creados, actualizados o destruidos dentro de esa transacción. Sin embargo, si se genera una excepción dentro de una de estas devoluciones de llamada, la excepción se disparará y los métodos restantes <code>after_commit</code> o<code>after_rollback</code> no se ejecutarán. Como tal, si su código de devolución de llamada podría generar una excepción, deberá rescatarlo y manejarlo dentro de la devolución de llamada para permitir que se ejecuten otras devoluciones de llamada.</p><p>ADVERTENCIA. El código ejecutado dentro de las devoluciones de llamada <code>after_commit</code> o <code>after_rollback</code> no están incluido en una transacción.</p><p>ADVERTENCIA. El uso de <code>after_create_commit</code> y <code>after_update_commit</code> en el mismo modelo solo permitirá que la última devolución de la llamada definida surta efecto y anulará todas las demás.</p><div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  after_create_commit :log_user_saved_to_db
  after_update_commit :log_user_saved_to_db

  private
  def log_user_saved_to_db
    puts 'User was saved to database'
  end
end

# prints nothing
&gt;&gt; @user = User.create

# updating @user
&gt;&gt; @user.save
=&gt; User was saved to database
</code></pre>
</div>
<p>También hay un alias para usar la devolución de llamada <code>after_commit</code> para crear y actualizar juntos:</p>
<ul>
<li><code>after_save_commit</code></li>
</ul>
<div class="code_container">
<pre><code class="language-ruby">class User &lt; ApplicationRecord
  after_save_commit :log_user_saved_to_db

  private
  def log_user_saved_to_db
    puts 'User was saved to database'
  end
end

# creating a User
&gt;&gt; @user = User.create
=&gt; User was saved to database

# updating @user
&gt;&gt; @user.save
=&gt; User was saved to database
</code></pre>
</div>


        <h3>Comentarios Sobre el Contenido</h3>
        <p>
          Las guías de rieles se administran y publican en latinadeveloper/railsguides.es en GitHub.
        </p>
        <p>
          Si lee esta guía y encuentra algún texto o código incorrecto que le interese, no dude en enviar una solicitud de extracción en el repositorio anterior.

          Consulte el archivo README en GitHub para saber cómo enviar una solicitud de extracción.
          Please contribute if you see any typos or factual errors.
        </p>

      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </div>
</body>
</html>
